<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Completamento Ordini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #9ca3af;
      margin-bottom: 20px;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }
    .toolbar-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    label {
      font-size: 0.9rem;
    }
    select, input[type="file"], button {
      font-size: 0.9rem;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
    }
    button {
      cursor: pointer;
      border: none;
      background: #2563eb;
      transition: background 0.15s;
    }
    button:hover {
      background: #1d4ed8;
    }
    button.secondary {
      background: #374151;
    }
    button.secondary:hover {
      background: #4b5563;
    }
    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .order-card {
      background: #111827;
      border-radius: 12px;
      padding: 14px;
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .order-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: #f9fafb;
    }
    .order-meta {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-0 { background: #7f1d1d; color: #fecaca; }
    .badge-50 { background: #78350f; color: #fef3c7; }
    .badge-100 { background: #14532d; color: #bbf7d0; }
    .info-row {
      font-size: 0.8rem;
      color: #d1d5db;
    }
    .info-label {
      font-weight: 600;
      color: #9ca3af;
      margin-right: 4px;
    }
    .photos {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 6px;
      margin-top: 4px;
    }
    .photos img {
      width: 100%;
      border-radius: 8px;
      object-fit: cover;
      aspect-ratio: 1;
      border: 1px solid #1f2937;
    }
    .completion-row {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }
    .status-text {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .saved-banner {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #22c55e;
      display: none;
    }
    .empty-message {
      margin-top: 30px;
      text-align: center;
      color: #9ca3af;
      font-size: 0.95rem;
    }
    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üì¶ Gestione Completamento Ordini</h1>
  <p class="subtitle">
    Importa il file HTML degli ordini (con le foto) e indica lo stato:
    0% = nulla fatto ¬∑ 50% = ordinato ¬∑ 100% = consegnato.
  </p>

  <div class="toolbar">
    <div class="toolbar-group">
      <label for="htmlInput">File ordini (HTML):</label>
      <input type="file" id="htmlInput" accept=".htm,.html">
    </div>

    <div class="toolbar-group">
      <label for="filterCompletion">Filtro completamento:</label>
      <select id="filterCompletion">
        <option value="all">Tutti</option>
        <option value="0">Solo 0% - Da fare</option>
        <option value="50">Solo 50% - Ordinato</option>
        <option value="100">Solo 100% - Consegnato</option>
      </select>
    </div>

    <div class="toolbar-group">
      <button id="exportCsvBtn" class="secondary">‚¨áÔ∏è Esporta CSV</button>
      <button id="clearBtn" class="secondary">üóëÔ∏è Svuota memoria</button>
    </div>
  </div>

  <p class="small">
    I completamenti sono salvati nel browser (localStorage). Puoi chiudere e riaprire questa pagina: i dati restano.
  </p>

  <div id="savedBanner" class="saved-banner">‚úÖ Completamento salvato.</div>

  <div id="ordersContainer" class="orders-grid"></div>
  <div id="emptyMessage" class="empty-message" style="display:none;">
    Nessun ordine caricato. Importa un file HTML di ordini per iniziare.
  </div>
</div>

<script>
  // Struttura interna: [{ id, titolo, struttura, reparto, descrizione, data, photos[], completamento }]
  let orders = [];

  const STORAGE_KEY = 'ordiniCompletamento_v1';

  const htmlInput = document.getElementById('htmlInput');
  const filterSelect = document.getElementById('filterCompletion');
  const container = document.getElementById('ordersContainer');
  const emptyMessage = document.getElementById('emptyMessage');
  const savedBanner = document.getElementById('savedBanner');
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  const clearBtn = document.getElementById('clearBtn');

  // ------------ Persistenza ------------

  function saveOrders() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
      showSavedBanner();
    } catch (e) {
      console.error('Errore nel salvataggio:', e);
    }
  }

  function loadOrders() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) {
        orders = parsed;
      }
    } catch (e) {
      console.error('Errore nel caricamento:', e);
    }
  }

  function showSavedBanner() {
    savedBanner.style.display = 'block';
    clearTimeout(showSavedBanner._timer);
    showSavedBanner._timer = setTimeout(() => {
      savedBanner.style.display = 'none';
    }, 1000);
  }

  // ------------ Import HTML ordini ------------

  htmlInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const text = reader.result;
      parseOrdersFromHtml(text);
      saveOrders();
      renderOrders();
    };
    reader.readAsText(file, 'utf-8');
  });

  function parseOrdersFromHtml(htmlText) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlText, 'text/html');

    const cards = doc.querySelectorAll('.order-card');
    if (!cards.length) {
      alert('Nel file non ho trovato card con classe ".order-card".');
      return;
    }

    const newOrders = [];
    cards.forEach((card, idx) => {
      const headerEl = card.querySelector('h2, h3, .order-header h2, .order-header h3');
      const titolo = headerEl ? headerEl.textContent.trim() : `Ordine #${idx + 1}`;

      let struttura = '';
      let reparto = '';
      let descrizione = '';
      let data = '';

      const rows = card.querySelectorAll('.info-row');
      rows.forEach(row => {
        const labelSpan = row.querySelector('.label, .info-label, span');
        if (!labelSpan) return;
        let label = labelSpan.textContent.trim().toLowerCase().replace(':', '');
        const fullText = row.textContent.trim();
        const value = fullText.replace(labelSpan.textContent, '').replace(':', '').trim();

        if (label.includes('struttura')) struttura = value;
        else if (label.includes('reparto')) reparto = value;
        else if (label.includes('descrizione')) descrizione = value;
        else if (label.includes('data')) data = value;
      });

      const photoEls = card.querySelectorAll('img');
      const photos = Array.from(photoEls).map(img => img.src);

      // chiave semistabile per non perdere i completamenti tra import successivi
      const key = `${struttura}|${reparto}|${descrizione}|${data}|${photos.length}`;

      // se esiste gi√† in memoria, recupero il completamento
      const existing = orders.find(o => o.key === key);

      newOrders.push({
        id: idx + 1,
        key,
        titolo,
        struttura,
        reparto,
        descrizione,
        data,
        photos,
        completamento: existing ? existing.completamento : 0
      });
    });

    orders = newOrders;
  }

  // ------------ Rendering ------------

  function renderOrders() {
    const filter = filterSelect.value; // all, 0, 50, 100

    const filtered = orders.filter(o => {
      if (filter === 'all') return true;
      return String(o.completamento) === filter;
    });

    if (!filtered.length) {
      container.innerHTML = '';
      emptyMessage.style.display = 'block';
      return;
    }

    emptyMessage.style.display = 'none';

    container.innerHTML = filtered.map(order => `
      <div class="order-card">
        <div class="order-header">
          <div>
            <div class="order-title">${escapeHtml(order.titolo)}</div>
            <div class="order-meta">
              ${order.struttura ? escapeHtml(order.struttura) + ' ¬∑ ' : ''}
              ${order.reparto ? escapeHtml(order.reparto) : ''}
            </div>
          </div>
          <span class="badge badge-${order.completamento}">
            ${order.completamento === 0 ? '0% ¬∑ Da fare'
              : order.completamento === 50 ? '50% ¬∑ Ordinato'
              : '100% ¬∑ Consegnato'}
          </span>
        </div>

        ${order.descrizione ? `
          <div class="info-row">
            <span class="info-label">Descrizione:</span>
            ${escapeHtml(order.descrizione)}
          </div>
        ` : ''}

        ${order.data ? `
          <div class="info-row">
            <span class="info-label">Data:</span>
            ${escapeHtml(order.data)}
          </div>
        ` : ''}

        ${order.photos && order.photos.length ? `
          <div class="info-row">
            <span class="info-label">Foto:</span> ${order.photos.length}
            <div class="photos">
              ${order.photos.map(src => `
                <img src="${src}" alt="Foto ordine">
              `).join('')}
            </div>
          </div>
        ` : ''}

        <div class="completion-row">
          <div class="status-text">Stato completamento:</div>
          <select data-key="${order.key}" onchange="onChangeCompletion(this)">
            <option value="0" ${order.completamento === 0 ? 'selected' : ''}>0% - Da fare</option>
            <option value="50" ${order.completamento === 50 ? 'selected' : ''}>50% - Ordinato</option>
            <option value="100" ${order.completamento === 100 ? 'selected' : ''}>100% - Consegnato</option>
          </select>
        </div>
      </div>
    `).join('');
  }

  // handler chiamato dal select inline
  window.onChangeCompletion = function(selectEl) {
    const key = selectEl.dataset.key;
    const value = Number(selectEl.value);

    const order = orders.find(o => o.key === key);
    if (!order) return;

    order.completamento = value;
    saveOrders();
    renderOrders(); // per aggiornare badge e testo
  };

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // ------------ Export CSV ------------

  exportCsvBtn.addEventListener('click', () => {
    if (!orders.length) {
      alert('Non ci sono ordini da esportare.');
      return;
    }
    const header = ['Struttura', 'Reparto', 'Descrizione', 'Data', 'Foto', 'Completamento'];
    const rows = orders.map(o => [
      o.struttura || '',
      o.reparto || '',
      o.descrizione || '',
      o.data || '',
      o.photos ? o.photos.length : 0,
      o.completamento
    ]);

    const csv = [header, ...rows]
      .map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(';'))
      .join('\r\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ordini_completamento.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // ------------ Svuota memoria ------------

  clearBtn.addEventListener('click', () => {
    if (!confirm('Vuoi davvero cancellare tutti i completamenti salvati?')) return;
    orders = [];
    localStorage.removeItem(STORAGE_KEY);
    renderOrders();
  });

  // ------------ Init ------------

  window.addEventListener('load', () => {
    loadOrders();
    renderOrders();
  });
</script>
</body>
</html>
