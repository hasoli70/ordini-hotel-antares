<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Inserimento Ordini Reparti</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: #e5e7eb;
        }

        h1, h2 {
            margin: 0;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
        }

        .header-subtitle {
            font-size: 13px;
            color: #9ca3af;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
            align-items: flex-start;
        }

        .card {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 16px;
            padding: 18px 18px 16px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        label {
            font-size: 13px;
            display: block;
            margin-bottom: 4px;
            color: #cbd5f5;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 7px 9px;
            border-radius: 8px;
            border: 1px solid #4b5563;
            background-color: #020617;
            color: #f9fafb;
            font-size: 13px;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        input[type="file"] {
            font-size: 12px;
            color: #e5e7eb;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.4);
        }

        .field-group {
            margin-bottom: 10px;
        }

        .horizontal-group {
            display: flex;
            gap: 10px;
        }

        .horizontal-group .field-group {
            flex: 1;
            margin-bottom: 0;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            gap: 6px;
        }

        .badge-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 7px 14px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.5);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #818cf8, #4f46e5);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            border: 1px solid #4b5563;
        }

        .btn-secondary:hover {
            background: rgba(30, 41, 59, 0.9);
        }

        .btn-small {
            padding: 4px 9px;
            font-size: 11px;
        }

        .btn-danger {
            background: #b91c1c;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-top: 10px;
        }

        .actions-row-left,
        .actions-row-right {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .photo-preview {
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #4b5563;
        }

        .photo-item img {
            width: 100%;
            height: 70px;
            object-fit: cover;
            display: block;
        }

        .photo-remove {
            position: absolute;
            top: 3px;
            right: 3px;
            background: rgba(15, 23, 42, 0.85);
            border-radius: 999px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
        }

        .photo-info {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 5px;
        }

        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .orders-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .order-card {
            border-radius: 14px;
            padding: 10px 11px;
            margin-bottom: 8px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(55, 65, 81, 0.9);
            display: grid;
            grid-template-columns: minmax(0, 1.6fr) minmax(0, 0.9fr) minmax(0, 0.7fr);
            gap: 8px;
            font-size: 12px;
        }

        .order-main {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .order-title {
            font-weight: 600;
        }

        .order-dept {
            font-size: 11px;
            color: #a5b4fc;
        }

        .order-notes {
            font-size: 11px;
            color: #9ca3af;
        }

        .order-meta {
            font-size: 11px;
            color: #9ca3af;
        }

        .order-status {
            display: inline-flex;
            align-items: center;
            padding: 2px 7px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-0 {
            background: rgba(22, 78, 99, 0.9);
            color: #f97316;
        }

        .status-50 {
            background: rgba(69, 26, 3, 0.9);
            color: #facc15;
        }

        .status-100 {
            background: rgba(22, 101, 52, 0.9);
            color: #4ade80;
        }

        .order-photos-count {
            font-size: 11px;
            color: #9ca3af;
        }

        .order-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
        }

        .order-photos-grid {
            margin-top: 6px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 4px;
        }

        .order-photos-grid img {
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #4b5563;
        }

        .pill {
            padding: 2px 7px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .pill-label {
            color: #9ca3af;
        }

        .pill-value {
            color: #e5e7eb;
            font-weight: 500;
        }

        .footer-row {
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #9ca3af;
        }

        #statusMessage {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: rgba(15, 23, 42, 0.96);
            border-radius: 999px;
            padding: 7px 12px;
            border: 1px solid rgba(52, 211, 153, 0.7);
            color: #bbf7d0;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 7px;
        }

        #statusMessage.error {
            border-color: rgba(248, 113, 113, 0.8);
            color: #fecaca;
        }

        @media (max-width: 980px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div>
            <div class="header-title">Gestione Ordini Reparti</div>
            <div class="header-subtitle">Inserimento, foto, filtro per stato, import/export JSON (data + orario)</div>
        </div>
        <div class="badge">
            <span class="badge-dot"></span>
            <span>Archivio ordini locale (file JSON)</span>
        </div>
    </div>

    <div class="main-layout">
        <!-- FORM INSERIMENTO -->
        <div class="card">
            <div class="card-title">
                Nuovo ordine
                <span style="font-size:11px;color:#9ca3af;">I campi con * sono obbligatori</span>
            </div>

            <form id="orderForm">
                <div class="field-group">
                    <label for="reparto">Reparto *</label>
                    <select id="reparto" required>
                        <option value="">Seleziona reparto...</option>
                        <option value="Cucina">Cucina</option>
                        <option value="Sala">Sala</option>
                        <option value="Bar">Bar</option>
                        <option value="Reception">Reception</option>
                        <option value="Piani">Piani</option>
                        <option value="Manutenzione">Manutenzione</option>
                        <option value="Wellness">Wellness</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>

                <div class="field-group">
                    <label for="titolo">Titolo ordine *</label>
                    <input type="text" id="titolo" required placeholder="Es. Acquisto tazze da cappuccino">
                </div>

                <div class="field-group">
                    <label for="descrizione">Descrizione dettagliata *</label>
                    <textarea id="descrizione" required placeholder="Descrivere esattamente cosa serve, misure, quantit√†, note tecniche..."></textarea>
                </div>

                <div class="horizontal-group">
                    <div class="field-group">
                        <label for="stato">Stato avanzamento *</label>
                        <select id="stato" required>
                            <option value="0">0% - Da fare</option>
                            <option value="50">50% - Ordinato</option>
                            <option value="100">100% - Consegnato</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label for="urgenza">Priorit√†</label>
                        <select id="urgenza">
                            <option value="Normale">Normale</option>
                            <option value="Alta">Alta</option>
                            <option value="Critica">Critica</option>
                        </select>
                    </div>
                </div>

                <div class="field-group">
                    <label for="note">Note interne (opzionale)</label>
                    <textarea id="note" placeholder="Note per direzione, info aggiuntive, link, ecc."></textarea>
                </div>

                <div class="field-group">
                    <label for="photosInput">Allega foto (pi√π file consentiti)</label>
                    <input type="file" id="photosInput" accept="image/*" multiple>
                    <div id="photosPreview" class="photo-preview"></div>
                    <div id="photoInfo" class="photo-info"></div>
                </div>

                <div class="actions-row">
                    <div class="actions-row-left">
                        <button type="submit" class="btn btn-primary">
                            ‚ûï Aggiungi ordine
                        </button>
                    </div>
                    <div class="actions-row-right">
                        <button type="button" id="clearFormBtn" class="btn btn-secondary btn-small">
                            Pulisci form
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- LISTA ORDINI -->
        <div class="card">
            <div class="orders-header">
                <span class="card-title">Ordini salvati</span>
                <div class="filter-group">
                    <span>Filtro stato:</span>
                    <select id="filterStatus" style="font-size:12px;padding:4px 7px;border-radius:999px;border:1px solid #4b5563;background:#020617;color:#e5e7eb;">
                        <option value="all">Tutti</option>
                        <option value="0">0%</option>
                        <option value="50">50%</option>
                        <option value="100">100%</option>
                    </select>
                </div>
            </div>

            <div class="actions-row" style="margin-bottom:8px;">
                <div class="actions-row-left">
                    <button type="button" id="exportBtn" class="btn btn-secondary btn-small">
                        üíæ Esporta JSON
                    </button>
                    <label class="btn btn-secondary btn-small" style="cursor:pointer;">
                        üìÇ Importa JSON
                        <input type="file" id="importInput" accept="application/json" style="display:none;">
                    </label>
                </div>
                <div class="actions-row-right">
                    <button type="button" id="clearAllBtn" class="btn btn-danger btn-small">
                        üóëÔ∏è Cancella tutti
                    </button>
                </div>
            </div>

            <div class="orders-list" id="ordersList">
                <!-- Ordini renderizzati qui -->
            </div>
        </div>
    </div>
</div>

<div id="statusMessage"></div>

<script>
    // Array con le foto in preparazione per il nuovo ordine (DataURL)
    let tempPhotos = [];
    // Array principale con tutti gli ordini
    let orders = [];

    const photosInput = document.getElementById('photosInput');
    const photosPreview = document.getElementById('photosPreview');
    const photoInfo = document.getElementById('photoInfo');
    const ordersList = document.getElementById('ordersList');
    const filterStatus = document.getElementById('filterStatus');
    const statusMessage = document.getElementById('statusMessage');

    // --- GESTIONE FOTO PER NUOVO ORDINE ---

    photosInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files || []);
        if (!files.length) {
            tempPhotos = [];
            renderPhotoPreview();
            return;
        }

        // Aggiungo le nuove foto a quelle gi√† selezionate (permette pi√π selezioni prima di salvare)
        let remaining = files.length;
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                tempPhotos.push(ev.target.result);
                remaining--;
                if (remaining === 0) {
                    renderPhotoPreview();
                }
            };
            reader.readAsDataURL(file);
        });

        // Resetta l'input cos√¨ puoi selezionare altre foto anche uguali
        e.target.value = "";
    });

    function renderPhotoPreview() {
        photosPreview.innerHTML = "";
        if (!tempPhotos.length) {
            photoInfo.textContent = "";
            return;
        }

        tempPhotos.forEach((src, idx) => {
            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
                <img src="${src}" alt="foto ordine">
                <div class="photo-remove" data-index="${idx}">‚úï</div>
            `;
            photosPreview.appendChild(div);
        });

        const count = tempPhotos.length;
        photoInfo.textContent = count === 1
            ? "1 foto allegata"
            : count + " foto allegate";

        photosPreview.querySelectorAll('.photo-remove').forEach(btn => {
            btn.addEventListener('click', () => {
                const index = parseInt(btn.getAttribute('data-index'));
                tempPhotos.splice(index, 1);
                renderPhotoPreview();
            });
        });
    }

    // --- INSERIMENTO ORDINE ---

    document.getElementById('orderForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const reparto = document.getElementById('reparto').value.trim();
        const titolo = document.getElementById('titolo').value.trim();
        const descrizione = document.getElementById('descrizione').value.trim();
        const stato = document.getElementById('stato').value;
        const urgenza = document.getElementById('urgenza').value;
        const note = document.getElementById('note').value.trim();

        if (!reparto || !titolo || !descrizione) {
            showStatus("Compila tutti i campi obbligatori (*).", true);
            return;
        }

        const now = new Date();
        const data = now.toLocaleDateString('it-IT'); // solo data
        const ora = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); // solo orario

        const order = {
            id: Date.now().toString(),
            reparto,
            titolo,
            descrizione,
            stato: parseInt(stato, 10), // 0, 50, 100
            urgenza,
            note,
            photos: [...tempPhotos],   // copie delle foto correnti
            data,                      // es: 30/11/2025
            ora                        // es: 14:35:21
        };

        orders.push(order);
        renderOrders();
        showStatus("Ordine aggiunto correttamente.");

        // Reset form
        e.target.reset();
        tempPhotos = [];
        renderPhotoPreview();
    });

    document.getElementById('clearFormBtn').addEventListener('click', () => {
        document.getElementById('orderForm').reset();
        tempPhotos = [];
        renderPhotoPreview();
    });

    // --- RENDER LISTA ORDINI ---

    function renderOrders() {
        ordersList.innerHTML = "";

        const filter = filterStatus.value; // 'all', '0', '50', '100'
        let filtered = orders.slice();

        if (filter !== 'all') {
            const target = parseInt(filter, 10);
            filtered = filtered.filter(o => o.stato === target);
        }

        if (!filtered.length) {
            ordersList.innerHTML = `<div style="font-size:12px;color:#9ca3af;">Nessun ordine presente.</div>`;
            return;
        }

        filtered
            .slice()
            .sort((a, b) => b.id.localeCompare(a.id)) // ordini pi√π recenti in alto
            .forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card';

                const statoClass = order.stato === 0 ? 'status-0' :
                                   order.stato === 50 ? 'status-50' : 'status-100';

                const statoLabel = order.stato + '%';

                card.innerHTML = `
                    <div class="order-main">
                        <div class="order-title">${escapeHtml(order.titolo)}</div>
                        <div class="order-dept">${escapeHtml(order.reparto)}</div>
                        <div class="order-notes">${escapeHtml(order.descrizione)}</div>
                        ${order.note ? `<div class="order-notes"><strong>Note:</strong> ${escapeHtml(order.note)}</div>` : ''}
                        ${order.photos && order.photos.length ? `
                            <div class="order-photos-grid">
                                ${order.photos.map(src => `<img src="${src}" alt="foto ordine">`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div>
                        <div class="order-meta">
                            <span class="pill">
                                <span class="pill-label">Priorit√†</span>
                                <span class="pill-value">${escapeHtml(order.urgenza || 'Normale')}</span>
                            </span>
                        </div>
                        <div style="margin-top:6px;">
                            <span class="order-photos-count">
                                Foto: ${order.photos ? order.photos.length : 0}
                            </span>
                        </div>
                    </div>
                    <div>
                        <div class="order-status ${statoClass}">
                            Stato: ${statoLabel}
                        </div>
                        <div style="margin-top:6px;font-size:11px;color:#9ca3af;">
                            <div><strong>Data:</strong> ${order.data || '-'}</div>
                            <div><strong>Ora:</strong> ${order.ora || '-'}</div>
                        </div>
                        <div class="order-actions" style="margin-top:6px;">
                            <button class="btn btn-secondary btn-small" data-id="${order.id}" data-action="delete">
                                Elimina
                            </button>
                        </div>
                    </div>
                `;
                ordersList.appendChild(card);
            });

        // Event handler per tasto Elimina
        ordersList.querySelectorAll('button[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                orders = orders.filter(o => o.id !== id);
                renderOrders();
                showStatus("Ordine eliminato.");
            });
        });
    }

    filterStatus.addEventListener('change', renderOrders);

    // --- EXPORT / IMPORT JSON ---

    document.getElementById('exportBtn').addEventListener('click', () => {
        if (!orders.length) {
            showStatus("Non ci sono ordini da esportare.", true);
            return;
        }

        const dataStr = JSON.stringify(orders, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8;' });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const now = new Date();
        const nameDate = now.toISOString().slice(0, 10); // YYYY-MM-DD
        a.href = url;
        a.download = `ordini_${nameDate}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showStatus("File JSON esportato (data + ora per ogni ordine).");
    });

    document.getElementById('importInput').addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const imported = JSON.parse(ev.target.result);
                if (!Array.isArray(imported)) {
                    throw new Error("Formato non valido");
                }

                // Normalizza campo data/ora se manca (vecchie versioni)
                imported.forEach(o => {
                    if (!o.data || !o.ora && o.dataOra) {
                        // caso in cui prima avevi un unico campo 'data' con data+ora
                        const parts = String(o.data || o.dataOra).split(' ');
                        o.data = parts[0] || '';
                        o.ora = parts[1] || '';
                    }
                    if (!o.id) {
                        o.id = Date.now().toString() + Math.random().toString(16).slice(2);
                    }
                    if (!Array.isArray(o.photos)) {
                        o.photos = [];
                    }
                });

                orders = imported;
                renderOrders();
                showStatus("Ordini importati correttamente.");
            } catch (err) {
                console.error(err);
                showStatus("Errore nell'import del file JSON.", true);
            } finally {
                e.target.value = "";
            }
        };
        reader.readAsText(file, 'utf-8');
    });

    document.getElementById('clearAllBtn').addEventListener('click', () => {
        if (!orders.length) {
            showStatus("Non ci sono ordini da cancellare.", true);
            return;
        }
        const sure = confirm("Vuoi cancellare TUTTI gli ordini?");
        if (!sure) return;
        orders = [];
        renderOrders();
        showStatus("Tutti gli ordini sono stati eliminati.");
    });

    // --- UTILITY ---

    function showStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.classList.toggle('error', !!isError);
        statusMessage.style.display = 'flex';

        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }

    function escapeHtml(str) {
        if (!str) return "";
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Avvio
    renderOrders();
</script>
</body>
</html>
